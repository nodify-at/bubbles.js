"use strict";!function(){function e(e,n){function t(t,a,o){var r,i={enableDrop:t.enableDrop,handleDrop:t.handleDrop,enableFlip:t.enableFlip,disableNavigationSingleNode:t.disableNavigationSingleNode,scaleFactor:t.scaleFactor,ready:function(e){},navigateTo:t.navigateTo,onClick:function(e){"function"==typeof t.nodeSelected&&t.nodeSelected(e),e.clickCount=e.clickCount?e.clickCount+1:1,e.detail}},s=$(".bubbletree").get(0);t.$watch("data",function(a,o){if(a!==o&&!r){var l=e.parse(t.data);r=n.build(l,s,i)}},!0)}return{restrict:"A",scope:{nodeSelected:"=",navigateTo:"=",data:"=",scaleFactor:"@",disableNavigationSingleNode:"@",enableDrop:"@",enableFlip:"@",handleDrop:"="},link:t}}var n=angular.module("tribefire.bubble",[]);n.directive("tribefireBubble",e),e.$inject=["DataParser","BubbleTreeFactory"]}(),function(){function e(){function e(e,n,t){var a={};return a.enableDrop=t.enableDrop,a.handleDrop=t.handleDrop,a.enableFlip=t.enableFlip,a.disableNavigationSingleNode=t.disableNavigationSingleNode,a.data=e,a.container=n,a.bubbleType="donut",a.scaleFactor=t.scaleFactor,a.ready=function(n,a){$(".amount").remove(),t.ready(e)},a.navigateTo=t.navigateTo,a.onClick=t.onClick,a.rootPath="./",new BubbleTree(a)}return{build:e}}var n=angular.module("tribefire.bubble");n.factory("BubbleTreeFactory",e)}();var TWEEN=TWEEN||function(){var e,n,t,a,o=[];return{start:function(e){t=setInterval(this.update,1e3/(e||60))},stop:function(){clearInterval(t)},add:function(e){o.push(e)},remove:function(n){e=o.indexOf(n),e!==-1&&o.splice(e,1)},update:function(){for(e=0,n=o.length,a=(new Date).getTime();e<n;)o[e].update(a)?e++:(o.splice(e,1),n--)}}}();TWEEN.Tween=function(e){var n={},t={},a={},o=1e3,r=0,i=null,s=TWEEN.Easing.Linear.EaseNone,l=null,c=null,u=null;this.to=function(n,t){null!==t&&(o=t);for(var r in n)null!==e[r]&&(a[r]=n[r]);return this},this.start=function(){TWEEN.add(this),i=(new Date).getTime()+r;for(var o in a)null!==e[o]&&(n[o]=e[o],t[o]=a[o]-e[o]);return this},this.stop=function(){return TWEEN.remove(this),this},this.delay=function(e){return r=e,this},this.easing=function(e){return s=e,this},this.chain=function(e){l=e},this.onUpdate=function(e){return c=e,this},this.onComplete=function(e){return u=e,this},this.update=function(a){var r,h;if(a<i)return!0;a=(a-i)/o,a=a>1?1:a,h=s(a);for(r in t)e[r]=n[r]+t[r]*h;return null!==c&&c.call(e,h),1!=a||(null!==u&&u.call(e),null!==l&&l.start(),!1)}},TWEEN.Easing={Linear:{},Quadratic:{},Cubic:{},Quartic:{},Quintic:{},Sinusoidal:{},Exponential:{},Circular:{},Elastic:{},Back:{},Bounce:{}},TWEEN.Easing.Linear.EaseNone=function(e){return e},TWEEN.Easing.Quadratic.EaseIn=function(e){return e*e},TWEEN.Easing.Quadratic.EaseOut=function(e){return-e*(e-2)},TWEEN.Easing.Quadratic.EaseInOut=function(e){return(e*=2)<1?.5*e*e:-.5*(--e*(e-2)-1)},TWEEN.Easing.Cubic.EaseIn=function(e){return e*e*e},TWEEN.Easing.Cubic.EaseOut=function(e){return--e*e*e+1},TWEEN.Easing.Cubic.EaseInOut=function(e){return(e*=2)<1?.5*e*e*e:.5*((e-=2)*e*e+2)},TWEEN.Easing.Quartic.EaseIn=function(e){return e*e*e*e},TWEEN.Easing.Quartic.EaseOut=function(e){return-(--e*e*e*e-1)},TWEEN.Easing.Quartic.EaseInOut=function(e){return(e*=2)<1?.5*e*e*e*e:-.5*((e-=2)*e*e*e-2)},TWEEN.Easing.Quintic.EaseIn=function(e){return e*e*e*e*e},TWEEN.Easing.Quintic.EaseOut=function(e){return(e-=1)*e*e*e*e+1},TWEEN.Easing.Quintic.EaseInOut=function(e){return(e*=2)<1?.5*e*e*e*e*e:.5*((e-=2)*e*e*e*e+2)},TWEEN.Easing.Sinusoidal.EaseIn=function(e){return-Math.cos(e*Math.PI/2)+1},TWEEN.Easing.Sinusoidal.EaseOut=function(e){return Math.sin(e*Math.PI/2)},TWEEN.Easing.Sinusoidal.EaseInOut=function(e){return-.5*(Math.cos(Math.PI*e)-1)},TWEEN.Easing.Exponential.EaseIn=function(e){return 0==e?0:Math.pow(2,10*(e-1))},TWEEN.Easing.Exponential.EaseOut=function(e){return 1==e?1:-Math.pow(2,-10*e)+1},TWEEN.Easing.Exponential.EaseInOut=function(e){return 0==e?0:1==e?1:(e*=2)<1?.5*Math.pow(2,10*(e-1)):.5*(-Math.pow(2,-10*(e-1))+2)},TWEEN.Easing.Circular.EaseIn=function(e){return-(Math.sqrt(1-e*e)-1)},TWEEN.Easing.Circular.EaseOut=function(e){return Math.sqrt(1- --e*e)},TWEEN.Easing.Circular.EaseInOut=function(e){return(e/=.5)<1?-.5*(Math.sqrt(1-e*e)-1):.5*(Math.sqrt(1-(e-=2)*e)+1)},TWEEN.Easing.Elastic.EaseIn=function(e){var n,t=.1,a=.4;return 0==e?0:1==e?1:(a||(a=.3),!t||t<1?(t=1,n=a/4):n=a/(2*Math.PI)*Math.asin(1/t),-(t*Math.pow(2,10*(e-=1))*Math.sin(2*(e-n)*Math.PI/a)))},TWEEN.Easing.Elastic.EaseOut=function(e){var n,t=.1,a=.4;return 0==e?0:1==e?1:(a||(a=.3),!t||t<1?(t=1,n=a/4):n=a/(2*Math.PI)*Math.asin(1/t),t*Math.pow(2,-10*e)*Math.sin(2*(e-n)*Math.PI/a)+1)},TWEEN.Easing.Elastic.EaseInOut=function(e){var n,t=.1,a=.4;return 0==e?0:1==e?1:(a||(a=.3),!t||t<1?(t=1,n=a/4):n=a/(2*Math.PI)*Math.asin(1/t),(e*=2)<1?-.5*t*Math.pow(2,10*(e-=1))*Math.sin(2*(e-n)*Math.PI/a):t*Math.pow(2,-10*(e-=1))*Math.sin(2*(e-n)*Math.PI/a)*.5+1)},TWEEN.Easing.Back.EaseIn=function(e){return e*e*(2.70158*e-1.70158)},TWEEN.Easing.Back.EaseOut=function(e){return(e-=1)*e*(2.70158*e+1.70158)+1},TWEEN.Easing.Back.EaseInOut=function(e){return(e*=2)<1?.5*e*e*(3.5949095*e-2.5949095):.5*((e-=2)*e*(3.5949095*e+2.5949095)+2)},TWEEN.Easing.Bounce.EaseIn=function(e){return 1-TWEEN.Easing.Bounce.EaseOut(1-e)},TWEEN.Easing.Bounce.EaseOut=function(e){return(e/=1)<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375},TWEEN.Easing.Bounce.EaseInOut=function(e){return e<.5?.5*TWEEN.Easing.Bounce.EaseIn(2*e):.5*TWEEN.Easing.Bounce.EaseOut(2*e-1)+.5};var BubbleTree=function(e,n,t){var a=this;if(a.version="2.0.2",a.$container=$(e.container),a.config=$.extend({rootPath:"",minRadiusLabels:40,minRadiusAmounts:20,minRadiusHideLabels:0,cutLabelsAt:50},e),a.tooltip=e.tooltipCallback?e.tooltipCallback:function(){},e.tooltip&&(a.tooltip=e.tooltip),a.style=e.bubbleStyles,a.ns=BubbleTree,a.nodesByUrlToken={},a.nodeList=[],a.iconsByUrlToken={},a.globalNodeCounter=0,a.displayObjects=[],a.bubbleScale=1,a.globRotation=0,a.currentYear=e.initYear,a.currentCenter=void 0,a.currentTransition=void 0,a.baseUrl="",a.loadData=function(e){$.ajax({url:e,dataType:"json",success:this.setData.bind(this)})},a.setData=function(e){var n=this;e||(e=n.config.data),n.initData(e),n.initPaper(),n.initBubbles(),n.initTween(),n.initHistory(),n.postProcess(e)},a.postProcess=function(e){if(e){var n=this;angular.forEach(e.children,function(e){n.postProcess(e)})}},a.initData=function(e){var n=this;e.level=0,n.preprocessData(e),n.traverse(e,0),n.treeRoot=e},a.preprocessData=function(e){var n=this,t=n.config.maxNodesPerLevel;if(t&&t<e.children.length){var a=n.sortChildren(e.children);a.reverse();var o,r=[],i=[],s=0;for(var l in e.children)l<t?r.push(e.children[l]):(i.push(e.children[l]),s+=Math.max(0,e.children[l].amount));e.children=r,e.children.push({label:"More",name:"more",amount:s,children:i,breakdown:o})}},a.traverse=function(e,n){var t,a,o=this,r=o.config.bubbleStyles;if(e.children||(e.children=[]),o.nodeList.push(e),e.famount=o.ns.Utils.formatNumber(e.amount),e.parent&&(e.level=e.parent.level+1),o.config.clearColors===!0&&(e.color=!1),r){var i=["color","shortLabel","icon"];$.each(i,function(n,t){r.hasOwnProperty("id")&&r.id.hasOwnProperty(e.id)&&r.id[e.id].hasOwnProperty(t)?e[t]=r.id[e.id][t]:e.hasOwnProperty("name")&&r.hasOwnProperty("name")&&r.name.hasOwnProperty(e.name)&&r.name[e.name].hasOwnProperty(t)?e[t]=r.name[e.name][t]:e.hasOwnProperty("taxonomy")&&r.hasOwnProperty(e.taxonomy)&&r[e.taxonomy].hasOwnProperty(e.name)&&r[e.taxonomy][e.name].hasOwnProperty(t)&&(e[t]=r[e.taxonomy][e.name][t])})}for(e.color||(e.level>0?e.color=e.parent.color:e.color="#999999"),e.children.length<2&&e.color&&(e.color=vis4color.fromHex(e.color).saturation("*.86").x),e.level>0&&(t=e.parent.children,t.length>1&&(e.left=t[(n-1+t.length)%t.length],e.right=t[(Number(n)+1)%t.length],e.right==e.left&&(e.right=void 0))),a=void 0!==e.label&&""!==e.label?e.label:void 0!==e.token&&""!==e.token?e.token:""+o.globalNodeCounter,o.globalNodeCounter++,e.urlToken=a.toLowerCase().replace(/\W/g,"-");o.nodesByUrlToken.hasOwnProperty(e.urlToken);)e.urlToken+="-";o.nodesByUrlToken[e.urlToken]=e,e.maxChildAmount=0,e.children=o.sortChildren(e.children,!0,o.config.sortBy),$.each(e.children,function(n,t){t.parent=e,e.maxChildAmount=Math.max(e.maxChildAmount,t.amount),o.traverse(t,n)}),e.breakdowns&&(e.breakdownsByName={},$.each(e.breakdowns,function(n,t){t.famount=o.ns.Utils.formatNumber(t.amount),t.name&&(e.breakdownsByName[t.name]=t)}))},a.sortChildren=function(e,n,t){var o=[],r=!0;if("label"==t?(t=a.compareLabels,n=!1):t=a.compareAmounts,e.sort(t),n){for(;e.length>0;)o.push(r?e.pop():e.shift()),r=!r;return o}return e},a.compareAmounts=function(e,n){return e.amount>n.amount?1:e.amount==n.amount?0:-1},a.compareLabels=function(e,n){return e.label>n.label?1:e.label==n.label?0:-1},a.initPaper=function(){var e,n=this,t=n.$container,a=n.treeRoot,o=t.width(),r=t.height(),i=Raphael(t[0],o,r),s=.5*Math.min(o,r)-40,l=n.ns.Vector,c=new l(.5*o,.5*r);n.width=o,n.height=r,n.paper=i,e=Math.pow((Math.pow(a.amount,.6)+2*Math.pow(a.maxChildAmount,.6))/s,1.6666666667),n.a2radBase=n.ns.a2radBase=e,n.origin=c,$(window).resize(n.onResize.bind(n))},a.onResize=function(){var e,n=this,t=n.$container,a=t.width(),o=t.height(),r=.5*Math.min(a,o)-40,i=n.treeRoot;n.paper.setSize(a,o),n.origin.x=.5*a,n.origin.y=.5*o,n.width=a,n.height=o,e=Math.pow((Math.pow(i.amount,.6)+2*Math.pow(i.maxChildAmount,.6))/r,1.6666666667),n.a2radBase=n.ns.a2radBase=e,$.each(n.displayObjects,function(e,t){"bubble"==t.className&&(t.bubbleRad=n.ns.Utils.amount2rad(t.node.amount))}),n.currentCenter&&n.changeView(n.currentCenter.urlToken)},a.initTween=function(){this.tweenTimer=setInterval(this.loop,500/120)},a.initBubbles=function(){var e=this,n=e.treeRoot,t=!1;e.ns.Bubbles;e.bubbleClasses=[],e.config.hasOwnProperty("bubbleType")||(e.config.bubbleType=["plain"]),$.isArray(e.config.bubbleType)||(e.config.bubbleType=[e.config.bubbleType]),$.isArray(e.config.bubbleType)&&$.each(e.config.bubbleType,function(n){"icon"==e.config.bubbleType[n]&&(t=!0),e.bubbleClasses.push(e.getBubbleType(e.config.bubbleType[n]))});var a=e.createBubble(n,e.origin,0,0,n.color);e.traverseBubbles(a)},a.getBubbleType=function(e){var n=this,t=n.ns.Bubbles;return t.Donut},a.traverseBubbles=function(e){var n,t,a,o,r,i=this,s=i.ns.Utils.amount2rad,l=0,c=0,u=2*Math.PI;t=e.node.children,$.each(t,function(e,n){l+=s(n.amount)}),t.length>0&&(n=i.createRing(e.node,e.pos,0,{stroke:"#888","stroke-dasharray":"-"})),$.each(t,function(n,t){o=s(t.amount)/l*u,r=c+.5*o,isNaN(r)&&vis4.log(c,o,t.amount,l,u),t.centerAngle=r,a=i.createBubble(t,e.pos,0,r,t.color),c+=o,i.traverseBubbles(a)})},a.createBubble=function(e,n,t,a,o){var r,i=this,s=(i.ns,e.level);return isNaN(s)&&(s=0),s=Math.min(s,i.bubbleClasses.length-1),r=new i.bubbleClasses[s](e,i,n,t,a,o),i.displayObjects.push(r),r},a.createRing=function(e,n,t,a){var o,r=this,i=r.ns;return o=new i.Ring(e,r,n,t,a),r.displayObjects.push(o),o},a.changeView=function(e){var n,t,a,o=this,r=(o.paper,.35*Math.min(o.width,o.height)),i=o.ns,s=i.Utils,l=o.origin,c=s.amount2rad,u=o.treeRoot,h=o.nodesByUrlToken,d=h.hasOwnProperty(e)?h[e]:null,b=new i.Layout,f=2*Math.PI,p=o.getBubble.bind(o),g=o.getRing.bind(o),v=o.unifyAngle;if(null!==d){var m,E,y,w,T,k,M,C,B,x,N,O=!1,P=!1;for(a in o.displayObjects)o.displayObjects[a].hideFlag=!0;if(d==u||d.parent==u&&d.children.length<2){b.$(o).bubbleScale=o.config.scaleFactor?o.config.scaleFactor:1,b.$(l).x=.5*o.width,b.$(l).y=.5*o.height,m=p(u),d!=u&&(m.childRotation=-d.centerAngle),T=c(u.amount)+c(u.maxChildAmount)+40,B=g(u),b.$(B).rad=T;for(a in u.children)w=u.children[a],n=p(w),b.$(n).angle=v(w.centerAngle+m.childRotation),b.$(n).rad=T}else{var I=d;x=d.children.length<2?5:r/(c(d.amount)+1.5*c(d.maxChildAmount)),b.$(o).bubbleScale=x,m=p(d),o.currentCenter&&o.currentCenter==d.left?P=!0:o.currentCenter&&o.currentCenter==d.right&&(O=!0);var D=o.shortestAngleTo;O&&(D=o.shortestLeftTurn),P&&(D=o.shortestRightTurn),b.$(m).angle=D(m.angle,0),T=(c(d.amount)+c(d.maxChildAmount))*x+20,B=g(d),b.$(B).rad=T,E=p(d.parent),E.childRotation=-d.centerAngle;for(var W=E;W&&W.node.parent;)W=p(W.node.parent,!0),b.$(W).rad=0;b.$(E).rad=0;var A=.5*o.width;if(k=0-Math.max(.8*A-x*(c(d.parent.amount)+c(Math.max(1.15*d.amount+1.15*d.maxChildAmount,.85*d.left.amount,.85*d.right.amount))),x*c(d.parent.amount)*-1+.15*A)+A,d.left&&d.right){x*c(Math.max(d.left.amount,d.right.amount))}N=T+k,b.$(l).x=.5*o.width-k-(d!=I?.35*T:0),b.$(l).y=.5*o.height,new vis4.DelayedTask(1500,vis4,vis4.log,l,E.pos),k+=.1*o.width,B=g(d.parent),b.$(B).rad=k,b.$(m).rad=k;var U=0-(d!=I?I.centerAngle+m.childRotation:0);for(a in d.children)w=d.children[a],n=p(w),b.$(n).angle=o.shortestAngleTo(n.angle,w.centerAngle+m.childRotation+U),b.$(n).rad=T;var R=.07*o.height;d.left&&(y=d.left,M=c(y.amount)*x,C=f-Math.asin((.5*o.paper.height+M-R)/k),n=p(y),b.$(n).rad=k,b.$(n).angle=D(n.angle,C)),d.right&&(y=d.right,M=c(y.amount)*x,C=Math.asin((.5*o.paper.height+M-R)/k),n=p(y),b.$(n).rad=k,b.$(n).angle=D(n.angle,C)),d=I}for(a in o.displayObjects){var L=o.displayObjects[a];L.hideFlag&&L.visible?(b.$(L).alpha=0,"bubble"==L.className&&L.node.level>1&&(b.$(L).rad=0),b.hide(L)):L.hideFlag||(b.$(L).alpha=1,L.visible||(L.alpha=0,b.show(L)))}t=new i.Transitioner($.browser.msie||o.currentCenter==d?0:560),t.changeLayout(b),o.currentTransition=t,!o.currentCenter&&$.isFunction(o.config.firstNodeCallback)&&o.config.firstNodeCallback(d),o.currentCenter=d}else s.log("node "+e+" not found")},a.unifyAngle=function(e){for(var n=Math.PI,t=2*n;e>=t;)e-=t;for(;e<0;)e+=t;return e},a.shortestAngle=function(e,n){var t=Math.PI,o=2*t,r=a.unifyAngle;e=r(e),n=r(n);var i=n-e;return i>t&&(i-=o),i<-t&&(i+=o),i},a.shortestAngleTo=function(e,n){return e+a.shortestAngle(e,n)},a.shortestLeftTurn=function(e,n){var t=a.shortestAngle(e,n);return t>0&&(t-=2*Math.PI),e+t},a.shortestRightTurn=function(e,n){var t=a.shortestAngle(e,n);return t<0&&(t=2*Math.PI+t),e+t},a.getBubble=function(e,n){return this.getDisplayObject("bubble",e,n)},a.getRing=function(e){return this.getDisplayObject("ring",e)},a.getDisplayObject=function(e,n,t){var a,o,r=this;for(a in r.displayObjects)if(o=r.displayObjects[a],o.className==e&&o.node==n)return t||(o.hideFlag=!1),o;vis4.log(e+" not found for node",n)},a.initHistory=function(){$.history.init(a.urlChanged.bind(a),{unescape:",/"})},a.freshUrl="",a.urlChanged=function(e){var n=this,t=n.currentTransition;n.freshUrl||e.indexOf("/~/")&&(n.baseUrl=e.substr(0,e.indexOf("/~/"))),n.freshUrl=e,t&&t.running?(vis4.log("transition is running at the moment, adding listener"),t.onComplete(n.changeUrl.bind(n))):n.changeUrl()},a.changeUrl=function(){var e,n=this,t=n.freshUrl.split("/"),a=t[t.length-1];""===n.freshUrl&&n.navigateTo(n.treeRoot),n.nodesByUrlToken.hasOwnProperty(a)?(e=n.getUrlForNode(n.nodesByUrlToken[a]),n.freshUrl!=e?$.history.load(e):n.navigateTo(n.nodesByUrlToken[a],!0)):n.navigateTo(n.treeRoot)},a.navigateTo=function(e,n){var t=this;"function"==typeof t.config.navigateTo&&(console.log(n),t.config.navigateTo(e));var a=t.getUrlForNode(e);n?t.changeView(e.urlToken):$.history.load(a),$(".label, .label2").removeClass("current"),$(".label2."+e.id).addClass("current"),$(".label."+e.id).addClass("current")},a.getUrlForNode=function(e){var n=[];for(n.push(e.urlToken);e.parent;)n.push(e.parent.urlToken),e=e.parent;return n.reverse(),a.baseUrl+"/~/"+n.join("/")},a.onNodeClick=function(e){},a.clean=function(){$(".label").remove()},this.loop=function(){TWEEN.update()},!a.config.hasOwnProperty("data"))throw new Error("no data");"string"==typeof a.config.data?a.loadData():new vis4.DelayedTask(1e3,a,a.setData,a.config.data)};BubbleTree.Styles={},BubbleTree.Layout=function(){var e=this;e.objects=[],e.props=[],e.toHide=[],e.toShow=[],e.$=function(e){var n,t,a,o=this;for(n in o.objects)if(t=o.objects[n],t==e)return o.props[n];return o.objects.push(e),a={},o.props.push(a),a},e.show=function(e){var n=this;n.toShow.push(e)},e.hide=function(e){var n=this;n.toHide.push(e)}},BubbleTree.Line=function(e,n,t,a,o,r){this.bc=e,this.o=t,this.angle=a,this.fromRad=o,this.attr=n,this.toRad=r,this.getXY=function(){this.x1=this.o.x+Math.cos(this.angle)*this.fromRad,this.y1=this.o.y-Math.sin(this.angle)*this.fromRad,this.x2=this.o.x+Math.cos(this.angle)*this.toRad,this.y2=this.o.y-Math.sin(this.angle)*this.toRad},this.init=function(){this.getXY(),console.log("foo","M"+this.x1+" "+this.y1+"L"+this.x2+" "+this.y2,n),this.path=this.bc.paper.path("M"+this.x1+" "+this.y1+"L"+this.x2+" "+this.y2).attr(this.attr)},this.draw=function(){this.getXY(),this.path.attr({path:"M"+this.x1+" "+this.y1+"L"+this.x2+" "+this.y2})},this.init()},BubbleTree.Loader=function(e){var n=this;n.config=e,n.ns=BubbleTree,n.loadData=function(){var e=this,n=e.config.data;console.log("loading url ",n),$.ajax({url:n,context:e,dataType:"json",success:function(e){this.run(e)}})},n.run=function(e){var n=this,t=new BubbleTree(n.config);t.setData(e),n.config.instance=t},!n.config.hasOwnProperty("data"),"string"==typeof n.config.data?n.loadData():n.run(n.config.data)},BubbleTree.MouseEventGroup=function(e,n){var t=this;t.target=e,t.members=n,t.click=function(e){var n,t,a=this,o=a.members;a.clickCallback=e;for(n in o)t=o[n],$(t).click(a.handleClick.bind(a))},t.handleClick=function(e){var n=this;n.clickCallback({target:n.target,origEvent:e,mouseEventGroup:n})},t.hover=function(e){var n,t,a=this,o=a.members;a.hoverCallback=e;for(n in o)t=o[n],$(t).hover(a.handleMemberHover.bind(a),a.handleMemberUnHover.bind(a))},t.unhover=function(e){var n=this;n.unhoverCallback=e},t.wasHovering=!1,t.mouseIsOver=!1,t.handleMemberHover=function(e){var n=this;new vis4.DelayedTask(25,n,n.handleMemberHoverDelayed,e)},t.handleMemberHoverDelayed=function(e){var n=this;n.mouseIsOver=!0,n.wasHovering||(n.wasHovering=!0,$.isFunction(n.hoverCallback)&&n.hoverCallback({target:n.target,origEvent:e,mouseEventGroup:n}))},t.handleMemberUnHover=function(e){var n=this;n.mouseIsOver=!1,new vis4.DelayedTask(40,n,n.handleMemberUnHoverDelayed,e)},t.handleMemberUnHoverDelayed=function(e){var n=this;n.mouseIsOver||(n.wasHovering=!1,$.isFunction(n.unhoverCallback)&&n.unhoverCallback({target:n.target,origEvent:e,mouseEventGroup:n}))},t.addMember=function(e){var n=this;n.hoverCallback&&$(e).hover(n.handleMemberHover.bind(n),n.handleMemberUnHover.bind(n)),n.members.push(e)},t.removeMember=function(e){var n,t=this,a=t.members,o=[];t.clickCallback&&$(e).unbind("click"),t.hoverCallback&&$(e).unbind("mouseenter mouseleave");for(n in a)a[n]!=e&&o.push(a[n]);t.members=o}},BubbleTree.Ring=function(e,n,t,a,o){var r=this;r.className="ring",r.rad=a,r.bc=n,r.attr=o,r.origin=t,r.alpha=1,r.visible=!1,r.node=e,r.init=function(){},r.draw=function(){var e=this,n=e.origin;e.visible&&e.circle.attr({cx:n.x,cy:n.y,r:e.rad,"stroke-opacity":e.alpha})},r.hide=function(){var e=this;e.circle.remove(),e.visible=!1},r.show=function(){var e=this;e.circle=e.bc.paper.circle(t.x,t.y,e.rad).attr(e.attr),e.visible=!0,e.circle.toBack()},r.init()},BubbleTree.Transitioner=function(e){var n=this;n.duration=e,n.running=!1,n.completeCallbacks=[],n.changeLayout=function(e){var n,t,a,o,r=this;r.running=!0,r.layout=e;for(n in e.toShow)t=e.toShow[n],$.isFunction(t.show)&&t.show();for(n in e.objects)if(t=e.objects[n],void 0!==t&&null!==t)if(a=e.props[n],r.duration>0){var i=new TWEEN.Tween(t),s={};for(o in a)s[o]=a[o];i.to(s,.6*r.duration),i.easing(TWEEN.Easing.Exponential.EaseOut),$.isFunction(t.draw)&&i.onUpdate(t.draw.bind(t)),n==e.objects.length-1&&i.onComplete(r._completed.bind(r)),i.start()}else{for(o in a)t[o]=a[o];t&&$.isFunction(t.draw)&&t.draw()}if(0===r.duration){for(n in e.objects)t=e.objects[n],t&&$.isFunction(t.draw)&&t.draw();r._completed()}},n.onComplete=function(e){var n=this;try{$.isFunction(e)&&n.completeCallbacks.push(e)}catch(e){}},n._completed=function(){var e,n,t=this,a=t.completeCallbacks;t.running=!1;for(e in t.layout.objects)n=t.layout.objects[e],n&&$.isFunction(n.draw)&&n.draw();for(e in t.layout.toHide)n=t.layout.toHide[e],n&&$.isFunction(n.hide)&&n.hide();for(e in a)a[e]()}},BubbleTree.Utils={},BubbleTree.Utils.log=function(){try{window.hasOwnProperty("console")&&console.log.apply(this,arguments)}catch(e){}},BubbleTree.Utils.amount2rad=function(e){return Math.pow(Math.max(0,e)/BubbleTree.a2radBase,.6)},BubbleTree.Utils.formatNumber=function(e){var n="";return e<0&&(e*=-1,n="-"),e>=1e12?n+Math.round(e/1e11)/10+"t":e>=1e9?n+Math.round(e/1e8)/10+"b":e>=1e6?n+Math.round(e/1e5)/10+"m":e>=1e3?n+Math.round(e/100)/10+"k":n+e},BubbleTree.Vector=function(e,n){var t=this;t.x=e,t.y=n,t.length=function(){var e=this;return Math.sqrt(e.x*e.x+e.y*e.y)},t.normalize=function(e){var n=this,t=n.length();e||(e=1),n.x*=e/t,n.y*=e/t},t.clone=function(){var e=this;return new BubbleTree.Vector(e.x,e.y)}},BubbleTree.Bubbles=BubbleTree.Bubbles||{},BubbleTree.Bubbles=BubbleTree.Bubbles||{},BubbleTree.Bubbles.Donut=function(e,n,t,a,o,r){var i=BubbleTree,s=i.Utils,l=this;l.className="bubble",l.node=e,l.paper=n.paper,l.origin=t,l.bc=n,l.rad=a,l.angle=o,l.color=r,l.alpha=1,l.visible=!1,l.ns=i,l.bubbleRad=s.amount2rad(this.node.amount),l.childRotation=0,l.getXY=function(){var e=this,n=e.origin,t=e.angle,a=e.rad;e.pos.x=n.x+Math.cos(t)*a,e.pos.y=n.y-Math.sin(t)*a},l.init=function(){var e=this;e.pos=new e.ns.Vector(0,0),e.getXY();var n,t,a,o=[],r=[],i=e.bc.config.bubbleStyles;e.node.shortLabel||(e.node.shortLabel=e.node.label.length>50?e.node.label.substr(0,30)+"...":e.node.label),e.breakdownOpacities=[.2,.7,.45,.6,.35],e.breakdownColors=[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1];for(t in e.node.breakdowns)n=e.node.breakdowns[t],n.famount=s.formatNumber(n.amount),a=n.amount/e.node.amount,o.push(a),r.push(n),i&&i.hasOwnProperty("name")&&i.name.hasOwnProperty(n.name)&&i.name[n.name].hasOwnProperty("opacity")&&(e.breakdownOpacities[r.length-1]=i.name[n.name].opacity),i&&i.hasOwnProperty("name")&&i.name.hasOwnProperty(n.name)&&i.name[n.name].hasOwnProperty("color")&&(e.breakdownColors[r.length-1]=i.name[n.name].color,e.breakdownOpacities[r.length-1]=1);e.node.breakdowns=r,e.breakdown=o;e.initialized=!0},l.onclick=function(n){var t=this;"function"==typeof t.bc.config.onClick&&t.bc.config.onClick(e),t.bc.navigateTo(t.node)},l.onhover=function(e){var n=this,t=n.bc.$container[0];e.node=n.node,e.target=n,e.bubblePos={x:n.pos.x,y:n.pos.y},e.mousePos={x:e.origEvent.pageX-t.offsetLeft,y:e.origEvent.pageY-t.offsetTop},e.type="SHOW",n.bc.tooltip(e)},l.onunhover=function(e){var n=this,t=n.bc.$container[0];e.node=n.node,e.target=n,e.type="HIDE",e.bubblePos={x:n.pos.x,y:n.pos.y},e.mousePos={x:e.origEvent.pageX-t.offsetLeft,y:e.origEvent.pageY-t.offsetTop},n.bc.tooltip(e)},this.draw=function(){var e=this,n=Math.max(5,e.bubbleRad*e.bc.bubbleScale),t=(e.pos.x,e.pos.y,e.getXY(),e.pos.x),a=e.pos.y;if(e.visible){e.alpha=0;var o={cx:t,cy:a,r:n,"fill-opacity":e.alpha,class:e.node.id+"-circle"};if(e.circle.attr(o),e.circle.node.setAttribute("class","circle-"+e.node.id),e.node.stroke?(e.dashedBorder.attr({cx:t,cy:a,r:n,"stroke-opacity":1}),e.dashedBorder.node.setAttribute("class",e.node.strokeClass)):e.node.dashed&&(e.dashedBorder.attr({cx:t,cy:a,r:n+3,"stroke-opacity":1,"stroke-dasharray":"- "}),e.dashedBorder.node.setAttribute("class","dashed")),e.breakdown.length>1){var r,i,s,l,c,u,h,d,b,f,p=.85*n,g=.5*-Math.PI;for(r in e.breakdown){f=e.breakdown[r]*Math.PI*2,i=t+Math.cos(g)*p,u=a+Math.sin(g)*p,s=t+Math.cos(g+f)*p,h=a+Math.sin(g+f)*p,l=t+Math.cos(g+f)*n,d=a+Math.sin(g+f)*n,c=t+Math.cos(g)*n,b=a+Math.sin(g)*n,g+=f;var v="M"+i+" "+u+" A"+p+","+p+" 0 "+(f>Math.PI?"1,1":"0,1")+" "+s+","+h+" L"+l+" "+d+" A"+n+","+n+" 0 "+(f>Math.PI?"1,0":"0,0")+" "+c+" "+b+" Z";e.breakdownArcs[r].attr({path:v,"stroke-opacity":.2*e.alpha,"fill-opacity":e.breakdownOpacities[r]*e.alpha})}}e.label.show(),e.label.css({width:2*n+"px",height:2*n+"px",opacity:1}),e.label.css({left:e.pos.x-n+"px",top:e.pos.y-n+"px"})}},this.hide=function(){var e,n=this;n.circle.remove(),n.dashedBorder.remove(),n.label.remove(),n.label2.remove(),n.visible=!1;for(e in n.breakdownArcs)n.breakdownArcs[e].remove()},l.show=function(){var n,t=this,a=Math.max(5,t.bubbleRad*t.bc.bubbleScale),o={stroke:!1};t.icon?o["fill-opacity"]=0:o.fill=t.color,t.circle=t.paper.circle(t.pos.x,t.pos.y,a).attr(o),$.isFunction(t.bc.config.initTooltip)&&t.bc.config.initTooltip(t.node,t.circle.node),t.dashedBorder=t.paper.circle(t.pos.x,t.pos.y,1.05*a).attr({stroke:t.node.stroke,"stroke-opacity":1,fill:!1,class:"dashed"});var r='<div class="desc">'+t.node.shortLabel+"</div>";if(t.node.icon&&(r+='<div class="icon-container"><img class="smooth node-img-'+t.node.id+'" src="'+t.node.icon+'"></div>'),t.node.images&&t.node.images.length){r+='<div class="images">';for(var n=0;n<t.node.images.length;n++){var i=e.images[n];r+='<img src="'+i+'" alt="profile">'}r+="</div>"}var s,l=t.node.icon?"transparent":t.color;t.node.detail&&!t.node.icon&&(s='<div class="card label '+t.node.id+'" > <div class="front" style="background: '+l+';">'+t.node.shortLabel+'</div> <div class="back" style="background: white; color: black;">'+t.node.detailContent+"</div> </div>");var c=s?s:'<div class="label '+t.node.id+(t.node.icon?" iconized ":"")+'" style="background:'+l+'">'+r+"</div>";t.label=$(c),t.node.detail&&!t.node.icon&&(t.label.flip({trigger:"manual"}),t.label.on("click",function(e){t.label.hasClass("current")&&$("."+t.node.id).flip("toggle")})),t.node.clazz&&t.label.addClass(t.node.clazz),t.bc.$container.append(t.label);var u=t.node;c=$(".label."+u.id),t.node.droppable&&t.enableDrop(u),u.timeProgress&&u.timeProgress<1&&(u.timeProgressBar&&u.timeProgressBar.destroy(),c.length&&(u.timeProgressBar=factory.build(c.get(0),"#009ddc","easeIn",u.timeProgress))),t.node.children.length>1&&($(t.circle.node).css({cursor:"pointer"}),$(t.label).css({cursor:"pointer"})),t.label2=$('<div class="label2 '+t.node.id+'"><span>'+t.node.shortLabel+"</span></div>"),t.bc.$container.append(t.label2);var h=[t.circle.node,t.label];if(t.breakdown.length>1){t.breakdownArcs={};for(n in t.breakdown){var d=t.breakdownColors[n]?t.breakdownColors[n]:"#fff",b=t.paper.path("M 0 0 L 2 2").attr({fill:d,"fill-opacity":.4*Math.random()+.3,stroke:"#fff"});t.breakdownArcs[n]=b,$.isFunction(t.bc.config.initTooltip)&&t.bc.config.initTooltip(t.node.breakdowns[n],b.node)}for(n in t.breakdownArcs)$(t.breakdownArcs[n].node).click(t.onclick.bind(t))}var f=new t.ns.MouseEventGroup(t,h);f.click(t.onclick.bind(t)),f.hover(t.onhover.bind(t)),f.unhover(t.onunhover.bind(t)),t.visible=!0},l.enableDrop=function(e){console.log("Enabling drop");var n=$(".label."+e.id),t=this;n.attr("drop","true"),n.addClass("droppable"),n.off("dragover"),n.off("dragleave"),n.off("dropover"),n.off("drop"),n.droppable({over:function(e,t){n.addClass("dragover")},out:function(e,t){n.removeClass("dragover")}}),n.on("dragover",function(e){e.stopPropagation(),e.preventDefault(),n.addClass("dragover")}),n.on("dragleave",function(e,t,a){e.stopPropagation(),e.preventDefault(),console.log("Dragging leave"),n.removeClass("dragover")}),n.on("drop",function(a,o,r){a.stopPropagation(),a.preventDefault(),n.removeClass("dragover"),t.bc.config.handleDrop(a,e)})},l.arcHover=function(e){var n,t=this,a=t.bc.$container[0],o=t.breakdownArcs,r=t.node.breakdowns;for(n in o)if(o[n].node==e.target)return e.node=r[n],e.bubblePos={x:t.pos.x,y:t.pos.y},e.mousePos={x:e.pageX-a.offsetLeft,y:e.pageY-a.offsetTop},e.target=t,e.type="SHOW",void t.bc.tooltip(e);vis4.log("cant find the breakdown node")},l.arcUnhover=function(e){var n,t=this,a=t.bc.$container[0],o=t.breakdownArcs,r=t.node.breakdowns;for(n in o)if(o[n].node==e.target)return e.node=r[n],e.bubblePos={x:t.pos.x,y:t.pos.y},e.mousePos={x:e.pageX-a.offsetLeft,y:e.pageY-a.offsetTop},e.type="HIDE",e.target=t,void t.bc.tooltip(e);vis4.log("cant find the breakdown node")},l.init()},BubbleTree.Bubbles=BubbleTree.Bubbles||{};